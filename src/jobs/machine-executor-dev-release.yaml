# src/jobs/machine-executor-dev-release.yaml
---
description: Machine executor version of continuoud integration and development build of circleci remote-docker executor.

executor:
  name: machine-image
  image-name: << parameters.executor-image-name >>
  resource-class: << parameters.executor-resource-class >>
shell: << parameters.shell >>

parameters:

  shell:
    description: default shell invocation. Override to support different shells or tools like 1password
    type: string
    default: /bin/bash -eo pipefail

  executor-image-name:
    description: specify machine executor
    type: string
    default: ubuntu-2204:2023.10.1 # last update: 01-09-2024

  executor-resource-class:
    description: specify executor resource class. Default is medium.
    type: enum
    enum: [medium, large, xlarge, 2xlarge, 2xlarge+]
    default: medium

  op-version:
    type: string
    default: 2.24.0-1

  teller-version:
    type: string
    default: 1.5.6

  vault-version:
    type: string
    default: 1.15.4-1

  conftest-version:
    type: string
    default: 0.48.0

  cis-docker-image-scan:
    description: perform CIS Docker Benchmark section 4 scan
    type: boolean
    default: false

  snyk-version:
    type: string
    default: 1.1268.0

  snyk-scan:
    description: perform snyk.io docker cve scan
    type: boolean
    default: false

  snyk-severity-threshold:
    description: snyk test reporting threshold
    type: string
    default: "low"

  snyk-organization:
    description: organization registered with snyk.io
    type: string
    default: ""

  snyk-token:
    description: snyk.io api-token
    type: env_var_name
    default: SNYK_TOKEN

  snyk-skip-base-image:
    description: optionally, skip performing cve scan of base image
    type: boolean
    default: false

  snyk-additional-args:
    description: additional custom command line flags
    type: string
    default: ""

  bats-version:
    type: string
    default: 1.10.0

  hadolint-version:
    type: string
    default: 2.12.0

  hadolint-additional-args:
    description: additional custom command line flags
    type: string
    default: ""

  trivy-version:
    type: string
    default: 0.48.2

  trivy-scan:
    description: perform trivy image scan
    type: boolean
    default: false

  trivy-severity:
    description: trivy scan reporting threshold
    type: string
    default: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"

  trivy-additional-args:
    description: additional custom command line flags
    type: string
    default: ""

  grype-version:
    type: string
    default: 0.74.0

  grype-scan:
    description: perform grype image scan
    type: boolean
    default: false

  grype-severity:
    description: trivy scan reporting threshold
    type: string
    default: "medium"

  grype-additional-args:
    description: additional custom command line flags
    type: string
    default: ""

  dockerfile:
    description: Name of dockerfile
    type: string
    default: Dockerfile

  path:
    description: Path to the directory containing your Dockerfile and build context
    type: string
    default: .

  registry:
    description: Name of registry
    type: string
    default: docker.io

  registry-login:
    description: username for reigstry access
    type: env_var_name
    default: DOCKER_LOGIN

  registry-password:
    description: password for registry access
    type: env_var_name
    default: DOCKER_PASSWORD

  image:
    description: Name of image
    type: string

  tag:
    description: Value for dev build tag
    type: string
    default: dev.${CIRCLE_SHA1:0:7}

  tag-annotation:
    description: Additional text prepended to semantic version tag
    type: string
    default: ""

  extra-build-args:
    description: >
      Extra flags to pass to docker build. For examples, see
      https://docs.docker.com/engine/reference/commandline/build
    type: string
    default: ""



  # bats-test:
  #   description: Run container configuration check bats test
  #   type: boolean
  #   default: false


  # container-name:
  #   description: name for running container
  #   type: string
  #   default: container-test

  # entry-point:
  #   description: name of shell ( bash | ash | etc)
  #   type: string
  #   default: /bin/bash

  # test-path:
  #   description: Name of folder with tests
  #   type: string
  #   default: test

  after-checkout:
    description: Optional steps to run after checking out the code.
    type: steps
    default: []

  before-build:
    description: Optional steps to run before building the docker image.
    type: steps
    default: []

  # after-build:
  #   description: Optional steps to run after building the docker image.
  #   type: steps
  #   default: []

steps:
  - checkout
  - packages:
      op-version: << parameters.op-version >>
      teller-version: << parameters.teller-version >>
      vault-version: << parameters.vault-version >>
      conftest-version: << parameters.conftest-version >>
      snyk-version: << parameters.snyk-version >>
      bats-version: << parameters.bats-version >>
      hadolint-version: << parameters.hadolint-version >>
      trivy-version: << parameters.trivy-version >>
      grype-version: << parameters.grype-version >>
  - when:
      name: Run after-checkout lifecycle hook steps.
      condition: << parameters.after-checkout >>
      steps: << parameters.after-checkout >>
  - lint:
      dockerfile: << parameters.dockerfile >>
      hadolint-additional-args: << parameters.hadolint-additional-args >>
  - confirm-registry:
      registry: << parameters.registry >>
      registry-login: << parameters.registry-login >>
      registry-password: << parameters.registry-password >>
  - when:
      name: Run before_build lifecycle hook steps.
      condition: << parameters.before-build >>
      steps: << parameters.before-build >>
  - when:
      name: perform CIS Docker Benchmark section 4 scan
      condition: << parameters.cis-docker-image-scan >>
      steps:
        - cis-scan:
            dockerfile: << parameters.dockerfile >>
  - build:
      dockerfile: << parameters.dockerfile >>
      path: << parameters.path >>
      image: << parameters.image >>
      tag: << parameters.tag-annotation >><< parameters.tag >>
      registry: << parameters.registry >>
      extra-build-args: << parameters.extra-build-args >>
  - when:
      name: Perform snyk cve scan
      condition: << parameters.snyk-scan >>
      requires:
        - build
      steps:
        - snyk-scan:
            registry: << parameters.registry >>
            image: << parameters.image >>
            tag: << parameters.tag-annotation >><< parameters.tag >>
            dockerfile: << parameters.dockerfile >>
            snyk-severity-threshold: << parameters.snyk-severity-threshold >>
            snyk-organization: << parameters.snyk-organization >>
            snyk-token: << parameters.snyk-token >>
            snyk-skip-base-image: << parameters.snyk-skip-base-image >>
            snyk-additional-args: << parameters.snyk-additional-args >>
  - when:
      name: Perform trivy image scan
      condition: << parameters.trivy-scan >>
      requires:
        - build
      steps:
        - trivy-scan:
            registry: << parameters.registry >>
            image: << parameters.image >>
            tag: << parameters.tag-annotation >><< parameters.tag >>
            dockerfile: << parameters.dockerfile >>
            trivy-severity: << parameters.trivy-severity >>
            trivy-additional-args: << parameters.trivy-additional-args >>
  - when:
      name: Perform grype image scan
      condition: << parameters.grype-scan >>
      requires:
        - build
      steps:
        - grype-scan:
            registry: << parameters.registry >>
            image: << parameters.image >>
            tag: << parameters.tag-annotation >><< parameters.tag >>
            dockerfile: << parameters.dockerfile >>
            grype-severity: << parameters.grype-severity >>
            grype-additional-args: << parameters.grype-additional-args >>

  # - when:
  #     name: perform bats container configuration test
  #     condition: << parameters.bats-test >>
  #     requires:
  #       - build
  #     steps:
  #       - bats:
  #           registry: << parameters.registry >>
  #           image: << parameters.image >>
  #           tag: << parameters.tag-annotation >><< parameters.tag >>
  #           container-name: << parameters.container-name >>
  #           entry-point: << parameters.entry-point >>
  #           test-path: << parameters.test-path >>

  # - when:
  #     name: Run after_build lifecycle hook steps.
  #     condition: << parameters.after-build >>
  #     steps: << parameters.after-build >>
  # - push:
  #     registry: << parameters.registry >>
  #     image: << parameters.image >>
  #     tag: << parameters.tag-annotation >><< parameters.tag >>
