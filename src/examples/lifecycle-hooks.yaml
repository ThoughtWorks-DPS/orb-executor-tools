# src/examples/lifecycle-hooks.yaml

description: |
    A standard workflow using a machine executor.

    - Git push on trunk triggers dev-build, git tag for release 
    - builds Dockerfile
    - docker.io credentials are set with the default ENV variables
    - no configuration tests are performed
    - no cve or cis scan is performed
    - after-checkout lifecycle hook used to inject secrets
    - before-build lifecycle hook used to post slack build message
    - after-build lifecycle hook used to run custom tests
    - after-publish lifecycle hook used to post slack success message

usage:
  version: 2.1

  orbs:
    executor-tools: twdps/executor-tools@0.1.0
    slack: circleci/slack@4.4.4

  workflows:
    version: 2

    my-circleci-executor-image-pipeline:
      jobs:
        - executor-tools/machine-executor-dev-release:
            image: my-circleci-executor
            after-checkout:
              - run:
                  name: inject environment variables
                  command: |
                    op inject -i op.env -o $BASH_ENV
                    source $BASH_ENV
            before-build:
              - slack/notify:
                  channel: ABCDEFG
                  custom: |
                    {
                      "blocks": [
                        {
                          "type": "section",
                          "fields": [
                            {
                              "type": "plain_text",
                              "text": "*build job triggered for my-circleci-executor*",
                              "emoji": true
                            }
                          ]
                        }
                      ]
                    }
                  event: always
            after-build:
              - run:
                  name: custom testing of the image
                  command: make test
            filters:
              branches:
                only: main
              tags:
                ignore: /.*/

        - executor-tools/publish:
            image: my-circleci-executor
            after-publish:
              - slack/notify:
                  channel: ABCDEFG
                  event: pass
            filters:
              branches:
                ignore: /.*/
              tags:
                only: /.*/
