# src/examples/tag-annotation.yaml

description: |
  Add annotation to tags during a multi-image build.
  
  - Git push on trunk triggers dev-build, git tag for release
  - builds Dockerfile.alpine and Dockerfile.slim
  - development builds are tagged with 'alpine-edge' and 'slim-edge'
  - semantic release tags are annotated as 'alpine-0.0.0' and 'slim-0.0.0'
  - release builds include image tagged with 'alpine-latest' and 'slim-latest'
  - docker.io credentials are set with the default ENV variables
  - conftest used to perform cis docker benchmark section 4 tests on alpine image
  - snyk used to perform scan for cve on alpine image
  - inspec used to test image configuration on alpine image
  - bats used to test image configuration on slim image

usage:
  version: 2.1

  orbs:
    executor-tools: twdps/executor-tools@0.1.0

  on-push-main: &on-push-main
    branches:
      only: /main/
    tags:
      ignore: /.*/

  on-tag-main: &on-tag-main
    branches:
      ignore: /.*/
    tags:
      only: /.*/

  workflows:
    version: 2

    circleci-alpine-executor-pipeline:
      jobs:
        - executor-tools/dev-release:
            name: alpine-dev-build
            context: team-context
            dockerfile: Dockerfile.alpine
            image: org/image-name
            tag: alpine-edge
            docker-cve-scan: true
            snyk-organization: org-name
            cis-docker-image-scan: true
            skip-base-image: true
            inspec-test: true
            test-path: teste
            container-name: run-alpine-image-edge
            filters: *on-push-main

        - executor-tools/publish:
            name: alpine-release
            context: team-context
            pull-tag: alpine-edge
            tag-annotation: alpine-      # results in 'alpine-' prepended to tag. e.g., :alpine-0.0.1'
            image: org/image-name
            release-tag: alpine-latest
            filters: *on-tag-main

    circleci-slim-executor-pipeline:
      jobs:
        - executor-tools/dev-release:
            name: slim-dev-build
            context: team-context
            dockerfile: Dockerfile.slim
            image: org/image-name
            tag: slim-edge
            bats-test: true
            container-name: run-slim-image-edge
            filters: *on-push-main

        - executor-tools/publish:
            name: slim-release
            context: team-context
            pull-tag: slim-edge
            tag-annotation: slim-       # results in 'slim-' prepended to tag. e.g., :slim-0.0.1'
            image: org/image-name
            release-tag: slim-latest
            filters: *on-tag-main
