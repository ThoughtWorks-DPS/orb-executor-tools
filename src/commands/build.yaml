# src/commands/build.yaml

description: Build executor Docker image.

parameters:

  dockerfile:
    description: Name of dockerfile
    type: string
    default: Dockerfile

  path:
    description: Path to the directory containing your Dockerfile and build context
    type: string
    default: .

  image:
    description: Name of image
    type: string

  tag:
    description: Value for tag
    type: string
    default: dev.${CIRCLE_SHA1:0:7}

  registry:
    description: Name of registry
    type: string
    default: docker.io

  extra-build-args:
    description: >
      Extra flags to pass to docker build. For examples, see
      https://docs.docker.com/engine/reference/commandline/build
    type: string
    default: ""

  honeycomb-trace:
    description: send buildevent trace events to honeycomb
    type: boolean
    default: false

steps:
  - when:
      name: start docker build span
      condition: << parameters.honeycomb-trace >>
      steps:
        - run: echo "STEP_START=$(date +%s)" >> $BASH_ENV
        - run: echo "STEP_SPAN_ID=$(echo docker-build | sum | cut -f 1 -d \ )" >> $BASH_ENV
  - unless:
      condition: << parameters.honeycomb-trace >>
      steps:
        - run:
            name: Build executor image
            command: |
              docker build \
                     <<#parameters.extra-build-args>><<parameters.extra-build-args>><</parameters.extra-build-args>> \
                     -f << parameters.dockerfile >> -t \
                     << parameters.registry >>/<< parameters.image >>:<< parameters.tag >> \
                     << parameters.path >>
  - when:
      condition: << parameters.honeycomb-trace >>
      steps:
        - run:
            name: Build executor image
            command: |
              buildevents cmd $CIRCLE_WORKFLOW_ID $STEP_SPAN_ID docker-build -- docker build \
                     <<#parameters.extra-build-args>><<parameters.extra-build-args>><</parameters.extra-build-args>> \
                     -f << parameters.dockerfile >> -t \
                     << parameters.registry >>/<< parameters.image >>:<< parameters.tag >> \
                     << parameters.path >>
  - when:
      name: stop docker build span
      condition: << parameters.honeycomb-trace >>
      steps:
        - run:
            name: finishing span for docker build
            command: buildevents step $CIRCLE_WORKFLOW_ID $STEP_SPAN_ID $STEP_START docker-build
            when: always 