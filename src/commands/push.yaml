# src/commands/push.yaml

description: Publish docker image to a registry

parameters:

  registry:
    description: Name of registry
    type: string
    default: docker.io

  image:
    description: Name of image
    type: string

  tag:
    description: Value for tag
    type: string

  honeycomb-trace:
    description: send honeycomb buildevent trace metrics
    type: boolean
    default: false

steps:
  - when:
      name: start docker push span
      condition: << parameters.honeycomb-trace >>
      steps:
        - run: echo "STEP_START=$(date +%s)" >> $BASH_ENV
        - run: echo "STEP_SPAN_ID=$(echo docker-push | sum | cut -f 1 -d \ )" >> $BASH_ENV
  - run:
      name: Publish a tagged image to the docker registry
      command: docker push << parameters.registry >>/<< parameters.image >>:<< parameters.tag >>
  - when:
      name: stop docker push span
      condition: << parameters.honeycomb-trace >>
      steps:
        - run:
            name: finishing span for docker push
            command: buildevents step $CIRCLE_WORKFLOW_ID $STEP_SPAN_ID $STEP_START docker-push
            when: always 