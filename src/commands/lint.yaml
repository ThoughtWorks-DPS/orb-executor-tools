# src/commands/lint.yaml

description: |
  Run Hadolint against Dockerfile. Note: uses latest version of hadolint docker image.

parameters:

  dockerfile:
    description: Name of dockerfile
    type: string
    default: Dockerfile

  honeycomb-trace:
    description: send honeycomb buildevent trace metrics
    type: boolean
    default: false

steps:
  - when:
      condition: << parameters.honeycomb-trace >>
      steps:
        - trace-step-start:
            id: lint
        # - run: echo "STEP_START=$(date +%s)" >> $BASH_ENV
        # - run: echo "STEP_SPAN_ID=$(echo lint | sum | cut -f 1 -d \ )" >> $BASH_ENV
  - unless:
      condition: << parameters.honeycomb-trace >>
      steps:  
        - run:
            name: hadolint Dockerfile
            command: docker run --rm -i hadolint/hadolint < << parameters.dockerfile >>
  - when:
      condition: << parameters.honeycomb-trace >>
      steps:
        - run: 
            name: hadolint Dockerfile with traces
            command: buildevents cmd $CIRCLE_WORKFLOW_ID $STEP_SPAN_ID lint -- docker run --rm -i hadolint/hadolint < << parameters.dockerfile >>    
  - when:
      condition: << parameters.honeycomb-trace >>
      steps:
        - trace-step-stop:
            id: lint
        # - run:
        #     name: finishing span for lint
        #     command: buildevents step $CIRCLE_WORKFLOW_ID $STEP_SPAN_ID $STEP_START lint
        #     when: always 