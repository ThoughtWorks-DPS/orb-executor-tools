# src/commands/confirm-registry.yaml

description: validate docker registry credentials

parameters:

  registry:
    description: Docker registry
    type: string
    default: docker.io

  image:
    description: Name of image
    type: string
    default: ""

  docker-login:
    description: username for reigstry access
    type: env_var_name
    default: DOCKER_LOGIN

  docker-password:
    description: password for registry access
    type: env_var_name
    default: DOCKER_PASSWORD

  aws-ecr:
    description: Use aws ecr
    type: boolean
    default: false

  aws-access-key-id:
    description: password for registry access
    type: env_var_name
    default: AWS_ACCESS_KEY_ID

  aws-secret-access-key:
    description: password for registry access
    type: env_var_name
    default: AWS_SECRET_ACCESS_KEY

  aws-region:
    description: AWS region used for aws credentials
    type: string
    default: AWS_DEFAULT_REGION

steps:
  - unless:
      condition: << parameters.aws-ecr >>
      name: Confirm Docker registry credentials are available and valid
      steps:
        - run:
            environment:
              REGISTRY: << parameters.registry >>
              DOCKER_LOGIN: << parameters.docker-login >>
              DOCKER_PASSWORD: << parameters.docker-password >>
            command: << include(scripts/confirm-registry.sh) >>
  - when:
      condition: << parameters.aws-ecr >>
      name: Confirm aws ecr credentials are available and valid
      steps:
        - run:
            environment:
              AWS_ECR: << parameters.aws-ecr >>
              REGISTRY: << parameters.registry >>
              IMAGE: << parameters.image >>
              AWS_ACCESS_KEY_ID: << parameters.aws-access-key-id >>
              AWS_SECRET_ACCESS_KEY: << parameters.aws-secret-access-key >>
              AWS_REGION: << parameters.aws-region >>
            command: << include(scripts/confirm-registry.sh) >>
