# src/commands/cve-scan.yaml

description: run snyk-cli:docker tests 

parameters:

  registry:
    description: Name of registry
    type: string
    default: docker.io

  image:
    description: Name of image
    type: string

  tag:
    description: Value for tag
    type: string
    default: dev.$CIRCLE_SHA1

  dockerfile:
    description: Name of dockerfile
    type: string
    default: Dockerfile

  severity-threshold:
    description: snyk test reporting threshold
    type: string
    default: low

  snyk-token:
    description: snyk api-token
    type: env_var_name
    default: SNYK_TOKEN

  snyk-organization:
    description: Name of snyk organization
    type: string

  skip-base-image:
    description: optionally, skip performing cve scan of base image
    type: boolean
    default: false

  honeycomb-trace:
    description: send buildevent trace events to honeycomb
    type: boolean
    default: false

steps:
  - when:
      name: start cve scan span
      condition: << parameters.honeycomb-trace >>
      steps:
        - run: echo "STEP_START=$(date +%s)" >> $BASH_ENV
        - run: echo "STEP_SPAN_ID=$(echo cve-scan | sum | cut -f 1 -d \ )" >> $BASH_ENV
  - run:
      name: configure snyk
      command: |
        snyk config set api=${<< parameters.snyk-token >>}
        snyk config set org=<< parameters.snyk-organization >>
  - unless:
      condition: << parameters.skip-base-image >>
      steps:
        - run:
            name: standard snyk docker scan
            command: |
              snyk test --docker << parameters.registry >>/<< parameters.image >>:<< parameters.tag >> \
                        --file=<< parameters.dockerfile >> --policy-path=./.snyk --severity-threshold=<< parameters.severity-threshold >>
  - when:
      condition: << parameters.skip-base-image >>
      steps:
        - run:
            name: snyk docker scan, skipping base image
            command: |
              snyk test --docker << parameters.registry >>/<< parameters.image >>:<< parameters.tag >> \
                        --file=<< parameters.dockerfile >> --exclude-base-image-vulns --policy-path=./.snyk --severity-threshold=<< parameters.severity-threshold >>
  - when:
      name: stop cve scan span
      condition: << parameters.honeycomb-trace >>
      steps:
        - run:
            name: finishing span for cve scan
            command: buildevents step $CIRCLE_WORKFLOW_ID $STEP_SPAN_ID $STEP_START cve-scan
            when: always 