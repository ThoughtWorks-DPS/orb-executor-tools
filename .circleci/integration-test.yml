---
version: 2.1

orbs:
  executor-tools: twdps/executor-tools@dev:<<pipeline.git.revision>>
  op: twdps/onepassword@1.2.0

globals:
  - &context orb-publishing
  - &registry ghcr.io/thoughtworks-dps

commands:

  set-environment:
    steps:
      - op/env:
          env-file: op.env

  before-job-message:
    parameters:
      msg:
        type: string
    steps:
      - run:
          name: echo before-msg
          command: echo "before - << parameters.msg >>"

  after-job-message:
    parameters:
      msg:
        type: string
    steps:
      - run:
          name: echo after-msg param
          command: echo "after - << parameters.msg >>"

jobs:

  test commands:
    docker:
      - image: twdps/circleci-executor-builder:alpine-stable
    steps:
      - checkout
      - setup_remote_docker
      - set-environment
      - executor-tools/lint:
          dockerfile: test/Dockerfile.alpine
          hadolint-additional-args: "--ignore DL3004"
      - executor-tools/confirm-registry:
          registry: *registry
      - executor-tools/cis-scan:
          dockerfile: test/Dockerfile.alpine
      - executor-tools/build:
          dockerfile: test/Dockerfile.build
          registry: *registry
          image: orb-executor-tools
      - executor-tools/snyk-scan:
            registry: *registry
            image: orb-executor-tools
            tag: dev.${CIRCLE_SHA1:0:7}
            dockerfile: test/Dockerfile.build
            snyk-severity-threshold: medium
            snyk-organization: twdps

  test machine packages:
    machine:
      image: ubuntu-2204:current
    resource_class: medium
    steps:
      - checkout
      - executor-tools/packages:
          op-version: 2.24.0-1
          teller-version: 1.5.6
          vault-version: 1.15.4-1
          conftest-version: 0.48.0
          snyk-version: 1.1268.0
          bats-version: 1.9.0
          hadolint-version: 2.12.0
          trivy-version: 0.48.2
          grype-version: 0.74.0
      - run:
          name: confirm installed version for available packages
          command: |
            set -exo pipefail
            op --version | grep "2.24.0"
            teller version | grep "1.5.6"
            vault version | grep "1.15.4"
            conftest --version | grep "0.48.0"
            snyk --version | grep "1.1268.0"
            bats --version | grep "1.9.0"
            hadolint --version | grep "2.12.0"
            trivy --version | grep "0.48.2"
            grype --version | grep "0.74.0"

workflows:

  integration tests:
    jobs:
      - test commands:
          context: *context
      # - test machine packages
      # - executor-tools/machine-executor-dev-release:
      #     context: *context
      #     dockerfile: test/Dockerfile.build
      #     image: orb-executor-tools
      #     registry: *registry
      #     snyk-scan: true
      #     severity-threshold: medium
      #     snyk-organization: twdps
      #     after-checkout:
      #       - set-environment
      #       - after-job-message:
      #           msg: "after checkout"
      #     before-build:
      #       - before-job-message:
      #           msg: "before build"
