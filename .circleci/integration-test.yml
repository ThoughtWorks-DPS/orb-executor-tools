---
version: 2.1

orbs:
  executor-tools: twdps/executor-tools@dev:<<pipeline.git.revision>>

globals:
  - &context orb-publishing
  - &orb-name twdps/executor-tools

#commands:

  # before-job-message:
  #   parameters:
  #     msg:
  #       type: string
  #   steps:
  #     - run:
  #         name: echo before-msg
  #         command: echo "before - << parameters.msg >>"

  # after-job-message:
  #   parameters:
  #     msg:
  #       type: string
  #   steps:
  #     - run:
  #         name: echo after-msg param
  #         command: echo "after - << parameters.msg >>"

jobs:

  test commands:
    docker:
      - image: twdps/circleci-executor-builder:alpine-stable
    steps:
      - checkout
      - executor-tools/lint:
          dockerfile: "test/Dockerfile.alpine"
          #additional-commands: "--ignore DL3004"

  test machine packages:
    machine:
      image: ubuntu-2204:current
    resource_class: medium
    steps:
      - checkout
      - executor-tools/packages:
          op-version: 2.24.0-1
          teller-version: 1.5.6
          vault-version: 1.15.4-1
          conftest-version: 0.48.0
          snyk-version: 1.1268.0
          bats-version: 1.9.0
          inspec-version: 6.6.0
          hadolint-version: 2.12.0
          trivy-version: 0.48.2
          grype-version: 0.74.0
      - run:
          name: confirm installed version for available packages
          command: |
            set -exo pipefail
            op --version | grep "2.24.0"
            teller version | grep "1.5.6"
            vault version | grep "1.15.4"
            conftest --version | grep "0.48.0"
            snyk --version | grep "1.1268.0"
            bats --version | grep "1.9.0"
            inspec --version | grep "6.6.0"
            hadolint --version | grep "2.12.0"
            trivy --version | grep "0.48.2"
            grype --version | grep "0.74.0"

workflows:

  integration tests:
    jobs:
      - test commands
      #- test machine packages
